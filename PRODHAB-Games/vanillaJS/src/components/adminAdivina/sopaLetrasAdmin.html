<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Items Manager</title>
  </head>
  <body>
    <admin-palabra-component
      id="admin-palabra-sopa-letras"
      title="Gestor de Preguntas"
      add-button-text="Agregar"
      edit-button-text="Modificar"
      delete-button-text="Quitar"
      add-sub-button-text="Añadir opción"
      prev-button-text="Atrás"
      next-button-text="Adelante"
      confirm-delete-text="¿Eliminar este ítem?"
      items-per-page-label-text="Elementos por página:"
      sub-placeholder-text="Añadir opción..."
      save-button-text="Guardar Cambios"
      cancel-button-text="Cancelar"
      hide-pagination
      hide-add-item
      hide-delete-button
    ></admin-palabra-component>

    <script src="../../juegosEnvironments.js"></script>
    <script src="../../services/sopaLetrasService.js"></script>
    <script src="../../services/completarTextoService.js"></script>
    <script src="../../services/juegosService.js"></script>

    <script src="admin-palabra-component.js"></script>
    <script type="module">
      document.addEventListener("DOMContentLoaded", () => {
        const identificadorJuego = 4;
        const gestor = document.getElementById("admin-palabra-sopa-letras");

        // ===== EVENTO: Guardar Subitems =====

        // ===== EVENTO: Guardar Palabras =====

        // ===== EVENTO: Guardar Subitems =====

        // ===== EVENTO: Eliminar Item =====

        // ===== EVENTO: Guardar Item Nuevo =====

        // ===== EVENTO: Modificar Item Existente =====

        // ===== EVENTO: Modificar Item Existente =====
        gestor.addEventListener("item-saved", async (e) => {
          const { titulo, isNew } = e.detail;
          console.log(titulo);

          if (isNew) return; // solo entra cuando se edita

          try {
            // Actualizar solo la descripción del juego #4
            const nuevosDatos = {
              Descripcion: titulo,
            };

            const juegoActualizado = await juegoService.actualizarJuego(
              identificadorJuego,
              nuevosDatos
            );
            console.log("Juego actualizado:", juegoActualizado);

            alert(`✓ Ronda "${titulo}" actualizada correctamente`);
          } catch (err) {
            console.error("Error al actualizar la descripción:", err);
            alert(`✗ Error al actualizar: ${err.message || err}`);
          }
        });

        // ===== CARGAR DATOS INICIALES =====

        // ===== CARGAR DATOS INICIALES =====

        // ===== EVENTO: Guardar Palabras =====
        gestor.addEventListener("subitems-save-requested", async (e) => {
          const { itemId, subItems } = e.detail;
          console.log(e.detail);

          try {
            const palabras = subItems.map((s) => s.texto);
            if (!palabras.length) return;

            console.log("Palabras a enviar:", palabras);
            console.log("ID del juego:", itemId);

            // 1. ENVIAR TODAS LAS PALABRAS (incluyendo duplicadas)
            const resp = await SopaLetrasService.crearPalabras(
              identificadorJuego,
              palabras
            );
            console.log("Respuesta del backend:", resp);

            // 2. Buscar el juego/item en memoria
            const item = gestor._items.find(
              (i) => String(i.id) === String(itemId)
            );
            if (!item) {
              console.log("ERROR: Juego no encontrado");
              return;
            }

            // 3. Procesar la respuesta del backend - PERMITIR DUPLICADOS
            if (
              resp &&
              Array.isArray(resp.palabras) &&
              resp.palabras.length > 0
            ) {
              resp.palabras.forEach((p) => {
                const textoPalabra = p.palabra;
                const idReal = String(p.idPalabraJuego);

                // AGREGAR TODAS LAS PALABRAS SIN VERIFICAR DUPLICADOS
                const nuevoSubitem = {
                  id: idReal,
                  texto: textoPalabra,
                };

                item.subItems.push(nuevoSubitem);
                console.log("Agregado subitem:", nuevoSubitem);
              });

              console.log(`Se agregaron ${resp.palabras.length} palabras`);
            }

            // 4. Limpiar pendientes
            const state = gestor._itemStates.get(itemId);
            if (state) {
              state.pendingSubItems = [];
            }

            // 5. Renderizar
            gestor._render();
            alert(`✓ ${palabras.length} palabras guardadas correctamente`);
          } catch (err) {
            console.error("ERROR:", err);
            alert(`✗ Error: ${err.message || err}`);
          }
        });
        // ===== EVENTO: Eliminar Palabra =====
        gestor.shadowRoot.addEventListener("click", async (e) => {
          if (!e.target.matches(".sublist .chip button")) return;

          const chipEl = e.target.closest(".chip");
          const palabraId = chipEl.dataset.id;
          if (!palabraId) return;

          // Buscar el item al que pertenece este subitem
          const item = gestor._items.find((i) =>
            i.subItems.some((s) => s.id === palabraId)
          );

          // Si no está en subItems, revisar en pendingSubItems
          let state;
          if (!item) {
            gestor._itemStates.forEach((st, key) => {
              if (st.pendingSubItems.some((s) => s.id === palabraId)) {
                item = gestor._items.find((i) => i.id === key);
                state = st;
              }
            });
          } else {
            state = gestor._itemStates.get(item.id) || { pendingSubItems: [] };
          }

          if (!item) return;

          // Caso 1: palabra pendiente (no guardada aún)
          if (state.pendingSubItems.some((s) => s.id === palabraId)) {
            state.pendingSubItems = state.pendingSubItems.filter(
              (s) => s.id !== palabraId
            );
            gestor._render();
            return;
          }

          // Caso 2: palabra existente
          if (!confirm("¿Deseas eliminar esta palabra?")) return;

          try {
            await SopaLetrasService.eliminarPalabra(palabraId);
            item.subItems = item.subItems.filter((s) => s.id !== palabraId);
            gestor._render();
            alert("Palabra eliminada correctamente");
          } catch (err) {
            console.error(err);
            alert(`Error al eliminar palabra: ${err.message}`);
          }
        });

        // ===== CARGAR DATOS INICIALES =====
        async function cargarDatos() {
          try {
            const items = await SopaLetrasService.cargarPalabras(
              identificadorJuego
            );

            console.log("Datos cargados:", items);
            gestor.loadItems(items);
            const title = items[0]?.nombre || "Gestor de Palabras del Juego";

            gestor.setAttribute("title", title);
          } catch (err) {
            console.error("Error al cargar:", err);
          }
        }
        cargarDatos();
      });
    </script>
  </body>
</html>
