<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Modal Dinámico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700;800;900&display=swap");
    </style>
  </head>
  <body>
    <!-- Scripts -->
    <script src="src/util/juegoFunctionUtility.js"></script>

    <script src="src/components/test/test.js"></script>
    <script src="src/services/testService.js"></script>
    <script src="src/services/juegosService.js"></script>

    <script src="src/juegosEnvironments.js"></script>
    <script src="src/components/test/test-component.js"></script>
    <script src="src/services/resultadoJuegoService.js"></script>
    <script src="src/services/sopaLetrasService.js"></script>
    <script src="src/components/sopa-letras-component/sopa-letras-component.js"></script>
    <script src="src/components/sopa-letras-component/modal-sopa.js"></script>
    <script src="src/services/ordenaLetrasService.js"></script>
    <script src="src/components/ordena-palabra-component/juego-ordena-letras-component.js"></script>
    <script src="src/components/ordena-palabra-component/intro-adivina-component.js"></script>
    <script src="src/components/ordena-palabra-component/ordena-letras-component.js"></script>
    <script src="src/services/completarTextoService.js"></script>
    <script src="src/components/completar/completar-texto-component.js"></script>
    <script src="menu-juegos-component.js"></script>

    <button onclick="ModalMenuJuegosPRODHAB.openAutoModal()">
      Abrir Modal
    </button>

    <script>
      const ModalMenuJuegosPRODHAB = (() => {
        let autoModalTimeout;
        let intervalTimer;
        const AUTO_CLOSE_TIME = 10 * 60 * 1000;
        let remainingTime = AUTO_CLOSE_TIME;

        // Función para cargar CSS externo y esperar
        function loadCSS(filename) {
          return new Promise((resolve, reject) => {
            const link = document.createElement("link");
            link.rel = "stylesheet";
            link.href = filename;
            link.onload = () => resolve();
            link.onerror = () => reject();
            document.head.appendChild(link);
          });
        }

        async function openAutoModal() {
          try {
            await loadCSS("testets.css"); // tu CSS externo
          } catch {
            console.warn("No se pudo cargar el CSS externo");
          }

          const htmlContent = `
<menu-juegos-component></menu-juegos-component>

        `;

          const overlay = document.createElement("div");
          overlay.className = "autoModal-overlay";

          const modal = document.createElement("div");
          modal.className = "autoModal";
          modal.setAttribute("role", "dialog");
          modal.setAttribute("aria-modal", "true");

          // Botón cerrar
          const closeBtn = document.createElement("button");
          closeBtn.className = "autoModal-close";
          // closeBtn.textContent = "✖ Cerrar";

          const content = document.createElement("div");
          content.className = "autoModal-content";
          content.tabIndex = 0;
          content.innerHTML = htmlContent;

          modal.appendChild(closeBtn);
          modal.appendChild(content);
          overlay.appendChild(modal);
          document.body.appendChild(overlay);
          document.body.style.overflow = "hidden";

          forceResponsive(content);
          startAutoCloseTimer();

          // Listeners
          const reset = () => startAutoCloseTimer();
          modal.onclick = (e) => {
            e.stopPropagation();
            reset();
          };
          modal.onkeydown = reset;
          closeBtn.onclick = () => closeAutoModal(overlay);
          overlay.onclick = (e) => {
            if (e.target === overlay) closeAutoModal(overlay);
          };
        }

        function closeAutoModal(overlay) {
          if (overlay) overlay.remove();
          document.body.style.overflow = "auto";
          clearTimeout(autoModalTimeout);
          clearInterval(intervalTimer);
        }

        function startAutoCloseTimer() {
          clearTimeout(autoModalTimeout);
          clearInterval(intervalTimer);
          remainingTime = AUTO_CLOSE_TIME;

          autoModalTimeout = setTimeout(() => {
            document.querySelector(".autoModal-overlay")?.remove();
            document.body.style.overflow = "auto";
          }, AUTO_CLOSE_TIME);

          intervalTimer = setInterval(() => {
            remainingTime -= 1000;
            console.log(
              `⏳ Tiempo restante: ${Math.floor(
                remainingTime / 60000
              )}m ${Math.floor((remainingTime % 60000) / 1000)}s`
            );
          }, 1000);
        }

        function forceResponsive(root) {
          const tables = root.querySelectorAll("table");
          tables.forEach((t) => {
            const wrap = document.createElement("div");
            wrap.className = "table-wrap";
            t.parentNode.insertBefore(wrap, t);
            wrap.appendChild(t);
          });
        }

        return { openAutoModal };
      })();
    </script>
  </body>
</html>
